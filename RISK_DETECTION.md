# 风险检测规则说明

## 高风险标识

机器人会自动检测以下高风险行为，这些通常是垃圾消息、广告或诈骗的强烈信号。

### 1. 频道转发 🚨

**检测规则：**
- 消息是从其他 Telegram 频道或群组转发而来
- 在消息信息中会显示 `forward_from_chat` 数据

**风险等级：** ⚠️ 高风险

**典型特征：**
```
⚠️ 【高风险】转发自频道: 推广频道 (@spam_channel)
```

**为什么高风险？**
- 大多数垃圾消息发送者使用频道作为"消息库"
- 通过转发频道消息可以批量发送到多个群组
- 正常用户很少转发频道消息到群聊

**建议置信度阈值：** > 0.80

---

### 2. Telegram 频道/群组链接 🚨

**检测规则：**
- 消息中包含 `t.me/` 或 `telegram.me/` 链接
- 可以是文本链接或超链接

**风险等级：** ⚠️ 高风险

**典型特征：**
```
⚠️ 【高风险】包含 Telegram 频道/群组链接: https://t.me/spam_channel
```

**常见链接格式：**
- `https://t.me/channel_name` - 公开频道
- `https://t.me/+private_code` - 私有群组/频道
- `https://t.me/joinchat/xxxxx` - 邀请链接（旧格式）
- `t.me/username` - 简写格式

**为什么高风险？**
- 主要目的是引流到其他频道/群组
- 常见于广告、传销、诈骗等垃圾消息
- 正常群聊很少分享其他群组链接

**建议置信度阈值：** > 0.80

---

### 3. 组合高风险 🔥

**频道转发 + Telegram 链接**

这是最高风险的组合，几乎 100% 是垃圾消息：

```
⚠️ 【高风险】转发自频道: 推广频道 (@spam_channel)
⚠️ 【高风险】包含 Telegram 频道/群组链接: https://t.me/spam_channel

🚨 风险标识: 频道转发 + 频道链接
⚠️  风险说明: 消息包含频道转发和频道链接，大概率为广告/诈骗消息！
```

**建议置信度阈值：** > 0.95

---

## 其他风险指标

### 中等风险 ⚠️

1. **外部链接**
   - 短链接服务（bit.ly, tinyurl.com 等）
   - 可疑域名
   - 大量链接

2. **联系方式**
   - 微信号
   - QQ 号
   - 电话号码
   - WhatsApp 等

3. **新成员首条消息**
   - 刚加入就发广告
   - 典型的垃圾账号行为

### 低风险 ✅

1. **正常链接**
   - 知名网站（YouTube, GitHub, 官方网站等）
   - 少量链接
   - 有上下文说明

2. **正常消息**
   - 日常交流
   - 问答讨论
   - 表情、贴纸

---

## 检测流程

```
消息到达
    ↓
检查是否为频道转发？
    ↓ 是 → 标记 [频道转发] 风险 + 0.4
    ↓ 否
    ↓
检查是否包含 t.me/ 链接？
    ↓ 是 → 标记 [频道链接] 风险 + 0.4
    ↓ 否
    ↓
检查其他风险因素
    ↓
LLM 综合分析
    ↓
计算最终置信度
    ↓
判定是否为垃圾消息
```

---

## 风险权重建议

| 风险因素 | 权重加成 | 说明 |
|---------|---------|------|
| 频道转发 | +0.4 | 强烈的垃圾消息信号 |
| Telegram 链接 | +0.4 | 引流行为，高风险 |
| 频道转发 + Telegram 链接 | +0.6 | 极高风险组合 |
| 外部短链接 | +0.2 | 可能是诈骗链接 |
| 联系方式（微信/QQ） | +0.3 | 典型广告行为 |
| 新成员 | +0.1 | 增加警惕 |
| 色情/暴力关键词 | +0.5 | 严重违规内容 |

---

## 实际案例

### 案例 1：典型频道推广垃圾消息

**消息内容：**
```
[转发自频道: 赚钱项目分享 (@make_money_fast)]
💰 每日签到领现金，邀请好友更多奖励！
点击加入：https://t.me/+AbCdEfGhIjKlMn
[图片]
```

**检测结果：**
- ✅ 频道转发：是
- ✅ Telegram 链接：是
- ✅ 包含图片：是
- ✅ 包含诱导词（赚钱、现金、奖励）：是

**风险评估：**
```
🚨 风险标识: 频道转发 + 频道链接
置信度：0.98 (98%)
判定：垃圾消息 ❌
处理：删除 + 封禁
```

---

### 案例 2：正常的链接分享

**消息内容：**
```
大家看看这个 GitHub 项目，很有用！
https://github.com/example/project
```

**检测结果：**
- ❌ 频道转发：否
- ❌ Telegram 链接：否
- ✅ 外部链接：是（但是 GitHub）
- ✅ 有上下文说明：是

**风险评估：**
```
风险标识: 无
置信度：0.15 (15%)
判定：正常消息 ✅
处理：保留
```

---

### 案例 3：仅频道转发（无链接）

**消息内容：**
```
[转发自频道: 新闻资讯 (@news_channel)]
今天的天气预报：北京晴，上海多云...
```

**检测结果：**
- ✅ 频道转发：是
- ❌ Telegram 链接：否
- ✅ 内容正常：是

**风险评估：**
```
🚨 风险标识: 频道转发
置信度：0.65 (65%)
判定：可能是垃圾消息
处理：取决于置信度阈值设置
```

---

## 配置建议

### 严格模式（推荐用于广告泛滥的群组）

```env
CONFIDENCE_THRESHOLD=0.6
```

- 频道转发或包含 Telegram 链接就会被删除
- 误判率可能略高，但能有效阻止垃圾消息

### 平衡模式（推荐用于一般群组）

```env
CONFIDENCE_THRESHOLD=0.7
```

- 需要较明确的垃圾消息特征
- 平衡准确性和误判率

### 宽松模式（推荐用于讨论群）

```env
CONFIDENCE_THRESHOLD=0.85
```

- 只删除非常明确的垃圾消息
- 误判率低，但可能漏掉一些垃圾消息

---

## 自定义规则

你可以在 `config.py` 中修改检测提示词，添加更多规则：

```python
SPAM_DETECTION_PROMPT = """
...
特别注意：
- 如果消息是从其他频道转发来的，大概率是广告/诈骗，置信度应该很高（>0.8）
- 如果消息包含 t.me/ 或 telegram.me/ 链接，大概率是引流广告，置信度应该很高（>0.8）
- 频道转发 + Telegram 链接的组合，几乎100%是垃圾消息

你还可以添加：
- 特定关键词黑名单
- 特定域名白名单
- 群组特定规则
...
"""
```

---

## 监控和调优

### 查看检测日志

每条消息都会在控制台显示详细信息：

```bash
# 运行机器人
python bot.py

# 或者保存到日志文件
python bot.py > bot.log 2>&1
```

### 调整阈值

根据实际情况调整：

1. **误删太多正常消息** → 提高阈值（0.7 → 0.8）
2. **漏掉很多垃圾消息** → 降低阈值（0.7 → 0.6）
3. **频道转发都想删除** → 在代码中硬编码规则

### 添加白名单

对于信任的频道，可以添加白名单：

```python
# 在 spam_detector.py 中
TRUSTED_CHANNELS = [
    "official_news",  # 官方新闻频道
    "team_updates",   # 团队更新频道
]

if message.forward_from_chat:
    if message.forward_from_chat.username in TRUSTED_CHANNELS:
        return {"should_delete": False, ...}
```

---

## 总结

**核心原则：**
1. 🚨 频道转发 + Telegram 链接 = 极高风险
2. ⚠️ 单独的频道转发或 Telegram 链接 = 高风险
3. 🔍 结合其他因素（内容、关键词）综合判断
4. ⚖️ 根据群组特点调整阈值

**最佳实践：**
- 从严格模式开始，逐步放松
- 定期查看日志，调整规则
- 维护管理员白名单
- 保留操作记录以便审查
